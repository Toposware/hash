// Copyright (c) 2021-2022 Toposware, Inc.
//
// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or
// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license
// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your
// option. This file may not be copied, modified, or distributed
// except according to those terms.

use super::traits::AnemoiHasher;
use crate::f64_utils::apply_rescue_inv_sbox;
use cheetah::Fp;

/// Digest for Anemoi
mod digest;
/// Hasher for Anemoi
mod hasher;
/// MDS matrix for Anemoi
mod mds;
/// Round constants for Anemoi
mod round_constants;
/// S-Box for Anemoi
mod sbox;

pub use digest::AnemoiDigest;
pub use hasher::AnemoiHash;

// ANEMOI CONSTANTS
// ================================================================================================

/// Function state is set to 12 field elements or 96 bytes.
/// 4 element of the state is reserved for capacity.
pub const STATE_WIDTH: usize = 12;
/// 8 elements of the state are reserved for rate.
pub const RATE_WIDTH: usize = 8;

/// The state is divided into two even-length rows.
pub const NUM_COLUMNS: usize = 6;

/// Four elements (32-bytes) are returned as digest.
pub const DIGEST_SIZE: usize = 4;

/// The number of rounds is set to 10 to provide 128-bit security level.
pub const NUM_HASH_ROUNDS: usize = 10;

// HELPER FUNCTIONS
// ================================================================================================

#[inline(always)]
/// Applies exponentiation of the current hash
/// state elements with the Anemoi S-Box.
pub(crate) fn apply_sbox(state: &mut [Fp; STATE_WIDTH]) {
    let mut x: [Fp; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
    let mut y: [Fp; NUM_COLUMNS] = state[NUM_COLUMNS..].try_into().unwrap();

    x.iter_mut()
        .enumerate()
        .for_each(|(i, t)| *t -= y[i].square().mul_by_u32(sbox::BETA));

    let mut x_alpha_inv = x;
    apply_rescue_inv_sbox(&mut x_alpha_inv);

    y.iter_mut()
        .enumerate()
        .for_each(|(i, t)| *t -= x_alpha_inv[i]);

    x.iter_mut()
        .enumerate()
        .for_each(|(i, t)| *t += y[i].square().mul_by_u32(sbox::BETA) + sbox::DELTA);

    state[..NUM_COLUMNS].copy_from_slice(&x);
    state[NUM_COLUMNS..].copy_from_slice(&y);
}

#[inline(always)]
/// Applies matrix-vector multiplication of the current
/// hash state with the Anemoi MDS matrix.
pub(crate) fn apply_mds(state: &mut [Fp; STATE_WIDTH]) {
    let x: [Fp; NUM_COLUMNS] = state[..NUM_COLUMNS].try_into().unwrap();
    let mut y: [Fp; NUM_COLUMNS] = state[NUM_COLUMNS..].try_into().unwrap();
    y[NUM_COLUMNS - 1] = y[0];

    let mut result = [Fp::zero(); STATE_WIDTH];
    for (i, r) in result.iter_mut().enumerate().take(NUM_COLUMNS) {
        for (j, s) in x.into_iter().enumerate().take(NUM_COLUMNS) {
            *r += mds::MDS[i * NUM_COLUMNS + j] * s;
        }
    }
    for (i, r) in result.iter_mut().enumerate().skip(NUM_COLUMNS) {
        for (j, s) in y.into_iter().enumerate() {
            *r += mds::MDS[(i - NUM_COLUMNS) * NUM_COLUMNS + j] * s;
        }
    }

    state.copy_from_slice(&result);
}

// ANEMOI PERMUTATION
// ================================================================================================

/// Applies Anemoi permutation to the provided state.
pub(crate) fn apply_permutation(state: &mut [Fp; STATE_WIDTH]) {
    for i in 0..NUM_HASH_ROUNDS {
        apply_round(state, i);
    }

    apply_mds(state)
}

/// Anemoi round function;
/// implementation based on algorithm 3 of <https://eprint.iacr.org/2020/1143.pdf>
#[inline(always)]
pub(crate) fn apply_round(state: &mut [Fp; STATE_WIDTH], step: usize) {
    // determine which round constants to use
    let c = &round_constants::C[step % NUM_HASH_ROUNDS];
    let d = &round_constants::D[step % NUM_HASH_ROUNDS];

    for i in 0..NUM_COLUMNS {
        state[i] += c[i];
        state[NUM_COLUMNS + i] += d[i];
    }

    apply_mds(state);
    apply_sbox(state);
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_sbox() {
        let mut input = [
            [Fp::zero(); 12],
            [Fp::one(); 12],
            [
                Fp::new(2024109077186517620),
                Fp::new(12588825917665470320),
                Fp::new(7760860720677708682),
                Fp::new(16177882880946617764),
                Fp::new(18191798079926199855),
                Fp::new(10100602807731852232),
                Fp::new(11835745083059610080),
                Fp::new(892561951383864769),
                Fp::new(13988037933637127990),
                Fp::new(14324215206530819782),
                Fp::new(13639172193883149028),
                Fp::new(1920157329771195333),
            ],
            [
                Fp::new(1928413705048742896),
                Fp::new(4522418955528112507),
                Fp::new(4604024865047881149),
                Fp::new(16185663939685474472),
                Fp::new(14408780645238915608),
                Fp::new(17033445442757683162),
                Fp::new(502097313377030940),
                Fp::new(6339402882007789789),
                Fp::new(12804686218596198210),
                Fp::new(12281970597440949873),
                Fp::new(12477861761310076503),
                Fp::new(3173909208507164602),
            ],
            [
                Fp::new(11913114315485008487),
                Fp::new(18141626625953537205),
                Fp::new(5466594395386693597),
                Fp::new(6469679528976785669),
                Fp::new(11345274226090193764),
                Fp::new(3081164339061692103),
                Fp::new(16079373693054707259),
                Fp::new(14965997961000837161),
                Fp::new(5860717931539236521),
                Fp::new(16577609164319677147),
                Fp::new(12174141410160517753),
                Fp::new(8824030838750282846),
            ],
            [
                Fp::new(2264436143936496420),
                Fp::new(11584707206727149111),
                Fp::new(10824636595394241357),
                Fp::new(15094969360501619238),
                Fp::new(2776107005139276639),
                Fp::new(10973335413158021045),
                Fp::new(13717364785956962097),
                Fp::new(14063318386091763240),
                Fp::new(17749083672895835715),
                Fp::new(6196407931777178051),
                Fp::new(14164789136584134239),
                Fp::new(9065243134059269077),
            ],
            [
                Fp::new(8814214913357488237),
                Fp::new(15724100487956173268),
                Fp::new(7142235699456086627),
                Fp::new(5068653739418772304),
                Fp::new(698706186255199095),
                Fp::new(17840849325155126713),
                Fp::new(7076372013939180650),
                Fp::new(17338632044032178558),
                Fp::new(15709981066789899118),
                Fp::new(15588725907967777404),
                Fp::new(6497338426358533130),
                Fp::new(15158059627781191733),
            ],
            [
                Fp::new(8408319644013278863),
                Fp::new(8810238424382262638),
                Fp::new(17851815567127402984),
                Fp::new(9171415913091609951),
                Fp::new(1771509058229150979),
                Fp::new(4046639637765528370),
                Fp::new(14693926144730479214),
                Fp::new(2203940597110882227),
                Fp::new(12105410459676786746),
                Fp::new(3801101816898933090),
                Fp::new(7208834587551219240),
                Fp::new(15716706316021131551),
            ],
            [
                Fp::new(4998506365808379243),
                Fp::new(15208719414762900578),
                Fp::new(13371019653976871462),
                Fp::new(5726894230476081554),
                Fp::new(9708279985692718518),
                Fp::new(3750738894470073493),
                Fp::new(10003716305067087534),
                Fp::new(971889734796253583),
                Fp::new(17465456643262127616),
                Fp::new(13906978308237797693),
                Fp::new(14210529306864364232),
                Fp::new(11017535886186269578),
            ],
            [
                Fp::new(410290834919184177),
                Fp::new(7161248779663427531),
                Fp::new(4277646107852266495),
                Fp::new(9438475434566402675),
                Fp::new(17559498806804689829),
                Fp::new(3224533887260173732),
                Fp::new(16423108785506381247),
                Fp::new(2532045072365757750),
                Fp::new(2649484840291090519),
                Fp::new(15987649591986014205),
                Fp::new(5182698842403106977),
                Fp::new(2544904436168575168),
            ],
        ];

        // Generated from https://github.com/vesselinux/anemoi-hash/
        let output = [
            [
                Fp::new(2635249152773512046),
                Fp::new(2635249152773512046),
                Fp::new(2635249152773512046),
                Fp::new(2635249152773512046),
                Fp::new(2635249152773512046),
                Fp::new(2635249152773512046),
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
            ],
            [
                Fp::new(17136669903572771321),
                Fp::new(17136669903572771321),
                Fp::new(17136669903572771321),
                Fp::new(17136669903572771321),
                Fp::new(17136669903572771321),
                Fp::new(17136669903572771321),
                Fp::new(9739452640566982996),
                Fp::new(9739452640566982996),
                Fp::new(9739452640566982996),
                Fp::new(9739452640566982996),
                Fp::new(9739452640566982996),
                Fp::new(9739452640566982996),
            ],
            [
                Fp::new(6132711489636036126),
                Fp::new(5918822188063673680),
                Fp::new(10446678021584155829),
                Fp::new(16964551615429726657),
                Fp::new(8496222303710632002),
                Fp::new(3477327031934251233),
                Fp::new(2202638584542667414),
                Fp::new(2364868573641652395),
                Fp::new(7563762104617216708),
                Fp::new(5131023974248620867),
                Fp::new(15577193992643265678),
                Fp::new(2002744822286548109),
            ],
            [
                Fp::new(8516356956060030828),
                Fp::new(17151260213857643203),
                Fp::new(16728524655330841118),
                Fp::new(16092206439755848833),
                Fp::new(17342345795614464189),
                Fp::new(6081008446748763062),
                Fp::new(6656207662753047206),
                Fp::new(16713933356042988271),
                Fp::new(7610483331539526435),
                Fp::new(1211264143768457202),
                Fp::new(13505035650457764834),
                Fp::new(3605241985596149370),
            ],
            [
                Fp::new(16899467629092983873),
                Fp::new(18132463529798524294),
                Fp::new(14539701963499931800),
                Fp::new(4508255734005078794),
                Fp::new(90397383874200573),
                Fp::new(18271567876927277141),
                Fp::new(848877993221171272),
                Fp::new(16277623761987857321),
                Fp::new(2619198227170866453),
                Fp::new(16206721901239863900),
                Fp::new(5173115140969115829),
                Fp::new(13821866989200063063),
            ],
            [
                Fp::new(4114877935645344089),
                Fp::new(1298473822225565460),
                Fp::new(139956930119091677),
                Fp::new(967955194690387694),
                Fp::new(14435407564648906903),
                Fp::new(870477618814990282),
                Fp::new(12267049565242416325),
                Fp::new(2264702414618527143),
                Fp::new(12912204536829586772),
                Fp::new(7674965166183680652),
                Fp::new(17925123739136397906),
                Fp::new(12549281313697703205),
            ],
            [
                Fp::new(3671976149642471943),
                Fp::new(11290391244065142847),
                Fp::new(4356060842796664305),
                Fp::new(16727875796200994647),
                Fp::new(6433951687777342085),
                Fp::new(8862904692471486319),
                Fp::new(8731898714809703440),
                Fp::new(16309570361572560422),
                Fp::new(11580350213066709247),
                Fp::new(9973117683696248088),
                Fp::new(17982611496779959930),
                Fp::new(17468157642886583319),
            ],
            [
                Fp::new(12887623233962299490),
                Fp::new(790477856098858301),
                Fp::new(12101399607856536077),
                Fp::new(5775740306705668201),
                Fp::new(18357832718944242404),
                Fp::new(6419466442382007069),
                Fp::new(5388801016629289639),
                Fp::new(16533913276800006179),
                Fp::new(13539039011294569797),
                Fp::new(9318087012520816981),
                Fp::new(3365216551120229265),
                Fp::new(4414259699169438764),
            ],
            [
                Fp::new(10998501662383288656),
                Fp::new(17065004905754582509),
                Fp::new(14761807523428159219),
                Fp::new(829246465715379829),
                Fp::new(5711697479944667205),
                Fp::new(9351454135009701661),
                Fp::new(4847699396439423268),
                Fp::new(6170721655567503245),
                Fp::new(11851929158458500207),
                Fp::new(7653497002256175893),
                Fp::new(8215553716999357425),
                Fp::new(7748022938793759377),
            ],
            [
                Fp::new(7061252014131344379),
                Fp::new(9569647199443577686),
                Fp::new(10701392684239731145),
                Fp::new(18417440558244288162),
                Fp::new(10214933021117073600),
                Fp::new(14907240941524323696),
                Fp::new(9765561107268105567),
                Fp::new(12042677452152309940),
                Fp::new(3592335798835096123),
                Fp::new(11354882668610971946),
                Fp::new(1220690774487256542),
                Fp::new(12009901643060524681),
            ],
        ];

        for i in input.iter_mut() {
            apply_sbox(i);
        }

        assert_eq!(input, output);
    }

    #[test]
    fn test_mds() {
        let mut input = [
            [Fp::zero(); 12],
            [Fp::one(); 12],
            [
                Fp::new(2024109077186517620),
                Fp::new(12588825917665470320),
                Fp::new(7760860720677708682),
                Fp::new(16177882880946617764),
                Fp::new(18191798079926199855),
                Fp::new(10100602807731852232),
                Fp::new(11835745083059610080),
                Fp::new(892561951383864769),
                Fp::new(13988037933637127990),
                Fp::new(14324215206530819782),
                Fp::new(13639172193883149028),
                Fp::new(1920157329771195333),
            ],
            [
                Fp::new(1928413705048742896),
                Fp::new(4522418955528112507),
                Fp::new(4604024865047881149),
                Fp::new(16185663939685474472),
                Fp::new(14408780645238915608),
                Fp::new(17033445442757683162),
                Fp::new(502097313377030940),
                Fp::new(6339402882007789789),
                Fp::new(12804686218596198210),
                Fp::new(12281970597440949873),
                Fp::new(12477861761310076503),
                Fp::new(3173909208507164602),
            ],
            [
                Fp::new(11913114315485008487),
                Fp::new(18141626625953537205),
                Fp::new(5466594395386693597),
                Fp::new(6469679528976785669),
                Fp::new(11345274226090193764),
                Fp::new(3081164339061692103),
                Fp::new(16079373693054707259),
                Fp::new(14965997961000837161),
                Fp::new(5860717931539236521),
                Fp::new(16577609164319677147),
                Fp::new(12174141410160517753),
                Fp::new(8824030838750282846),
            ],
            [
                Fp::new(2264436143936496420),
                Fp::new(11584707206727149111),
                Fp::new(10824636595394241357),
                Fp::new(15094969360501619238),
                Fp::new(2776107005139276639),
                Fp::new(10973335413158021045),
                Fp::new(13717364785956962097),
                Fp::new(14063318386091763240),
                Fp::new(17749083672895835715),
                Fp::new(6196407931777178051),
                Fp::new(14164789136584134239),
                Fp::new(9065243134059269077),
            ],
            [
                Fp::new(8814214913357488237),
                Fp::new(15724100487956173268),
                Fp::new(7142235699456086627),
                Fp::new(5068653739418772304),
                Fp::new(698706186255199095),
                Fp::new(17840849325155126713),
                Fp::new(7076372013939180650),
                Fp::new(17338632044032178558),
                Fp::new(15709981066789899118),
                Fp::new(15588725907967777404),
                Fp::new(6497338426358533130),
                Fp::new(15158059627781191733),
            ],
            [
                Fp::new(8408319644013278863),
                Fp::new(8810238424382262638),
                Fp::new(17851815567127402984),
                Fp::new(9171415913091609951),
                Fp::new(1771509058229150979),
                Fp::new(4046639637765528370),
                Fp::new(14693926144730479214),
                Fp::new(2203940597110882227),
                Fp::new(12105410459676786746),
                Fp::new(3801101816898933090),
                Fp::new(7208834587551219240),
                Fp::new(15716706316021131551),
            ],
            [
                Fp::new(4998506365808379243),
                Fp::new(15208719414762900578),
                Fp::new(13371019653976871462),
                Fp::new(5726894230476081554),
                Fp::new(9708279985692718518),
                Fp::new(3750738894470073493),
                Fp::new(10003716305067087534),
                Fp::new(971889734796253583),
                Fp::new(17465456643262127616),
                Fp::new(13906978308237797693),
                Fp::new(14210529306864364232),
                Fp::new(11017535886186269578),
            ],
            [
                Fp::new(410290834919184177),
                Fp::new(7161248779663427531),
                Fp::new(4277646107852266495),
                Fp::new(9438475434566402675),
                Fp::new(17559498806804689829),
                Fp::new(3224533887260173732),
                Fp::new(16423108785506381247),
                Fp::new(2532045072365757750),
                Fp::new(2649484840291090519),
                Fp::new(15987649591986014205),
                Fp::new(5182698842403106977),
                Fp::new(2544904436168575168),
            ],
        ];

        // Generated from https://github.com/vesselinux/anemoi-hash/
        let output = [
            [
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
                Fp::new(0),
            ],
            [
                Fp::new(8147406912193436531),
                Fp::new(7758383251114206897),
                Fp::new(10368704850089134836),
                Fp::new(10843318861430736890),
                Fp::new(16281387773089471997),
                Fp::new(628909419695644765),
                Fp::new(8147406912193436531),
                Fp::new(7758383251114206897),
                Fp::new(10368704850089134836),
                Fp::new(10843318861430736890),
                Fp::new(16281387773089471997),
                Fp::new(628909419695644765),
            ],
            [
                Fp::new(10120934987707487076),
                Fp::new(7239471261024994939),
                Fp::new(1573286541146447962),
                Fp::new(12226105759299677985),
                Fp::new(3826649797325432973),
                Fp::new(1373332226575015605),
                Fp::new(17970155922233855828),
                Fp::new(6571506430943824707),
                Fp::new(10892354902050650152),
                Fp::new(3808393263929797317),
                Fp::new(4074983897833179721),
                Fp::new(4952528552456154139),
            ],
            [
                Fp::new(6185358333401803169),
                Fp::new(17435899411036786568),
                Fp::new(5037703575335329872),
                Fp::new(9782497597649979444),
                Fp::new(9739993899295707538),
                Fp::new(1832247145592369083),
                Fp::new(8496146777759707707),
                Fp::new(18329083820365001101),
                Fp::new(3477358289872766644),
                Fp::new(11201045461004738060),
                Fp::new(4025445948897707634),
                Fp::new(12391752820486292308),
            ],
            [
                Fp::new(15593970203939873233),
                Fp::new(11651103313639936066),
                Fp::new(10031798022213044909),
                Fp::new(14392531456337631845),
                Fp::new(9642949801437415985),
                Fp::new(16466560785620371106),
                Fp::new(2879618331436265036),
                Fp::new(4373018822399350060),
                Fp::new(601768110468252712),
                Fp::new(17167296004416706946),
                Fp::new(15424871369695775979),
                Fp::new(14865430702572449744),
            ],
            [
                Fp::new(8788779318526934458),
                Fp::new(8700813659147027171),
                Fp::new(1954898586960178805),
                Fp::new(6303038411006889522),
                Fp::new(993464061664123592),
                Fp::new(7482161096713465834),
                Fp::new(14043133119300669095),
                Fp::new(10007221042015542651),
                Fp::new(5544430598253802449),
                Fp::new(8182270401995068775),
                Fp::new(14341640671217259560),
                Fp::new(8908436941829610385),
            ],
            [
                Fp::new(10339928885543416124),
                Fp::new(11779179105828760614),
                Fp::new(17522608703463498073),
                Fp::new(12178214114710885525),
                Fp::new(10709092482583503856),
                Fp::new(5289027586384077994),
                Fp::new(17586220827766053600),
                Fp::new(10609620052507157196),
                Fp::new(2278894367895495630),
                Fp::new(14816072029362003535),
                Fp::new(16637157898679313993),
                Fp::new(12563810157957250254),
            ],
            [
                Fp::new(3435036557592531281),
                Fp::new(10089635871319689008),
                Fp::new(16887584739585960835),
                Fp::new(307412654488241848),
                Fp::new(16994581377785261195),
                Fp::new(4651288066270520721),
                Fp::new(10780123496859354753),
                Fp::new(5757732692626981053),
                Fp::new(11280617485797844357),
                Fp::new(1571246642782989806),
                Fp::new(328872629930001771),
                Fp::new(13627649587002980199),
            ],
            [
                Fp::new(10005799363989937292),
                Fp::new(14040908619446529549),
                Fp::new(13014678782204648476),
                Fp::new(5522376469658824407),
                Fp::new(9718806473368962847),
                Fp::new(10916481051324711202),
                Fp::new(5119729308226474775),
                Fp::new(3294316858169922795),
                Fp::new(16728822994125763853),
                Fp::new(18252204569819551891),
                Fp::new(2035584492200478437),
                Fp::new(10754710461811700007),
            ],
            [
                Fp::new(6522698786673453433),
                Fp::new(16022443969980026676),
                Fp::new(14410023760015043696),
                Fp::new(3863318419510985636),
                Fp::new(5383102474341234228),
                Fp::new(14893518343274805040),
                Fp::new(3789765100514988907),
                Fp::new(2380292257065661777),
                Fp::new(13169346419291570352),
                Fp::new(9375230839106203139),
                Fp::new(3998532996146008587),
                Fp::new(13031835410173863475),
            ],
        ];

        for i in input.iter_mut() {
            apply_mds(i);
        }

        assert_eq!(input, output);
    }
}
